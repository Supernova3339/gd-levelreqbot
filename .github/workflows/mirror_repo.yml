name: Mirror All Branches to Organization

on:
  push:
    branches:
      - '**'
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.MIRROR_PAT }}

      - name: Configure Git
        run: |
          git config --global user.name "${{ github.repository_owner }}"
          git config --global user.email "${{ github.repository_owner }}@users.noreply.github.com"

      - name: Fetch all branches
        run: |
          git fetch --all

      - name: Set up mirror remote
        run: |
          git remote remove mirror 2>/dev/null || true
          git remote add mirror "https://${{ github.repository_owner }}:${{ secrets.MIRROR_PAT }}@github.com/GD-LevelReqBot/gd-levelreqbot.git"
          git fetch mirror --prune

      - name: Process each branch
        run: |
          for branch in $(git branch -r | grep -v 'origin/HEAD' | sed 's/origin\///'); do
            echo "Processing branch: $branch"
            git checkout $branch

            echo "Processing .mirrorignore (if exists)..."
            if [ -f ".mirrorignore" ]; then
              while IFS= read -r pattern || [ -n "$pattern" ]; do
                [[ $pattern =~ ^[[:space:]]*$ || $pattern =~ ^# ]] && continue
                echo "Removing files matching pattern: $pattern"
                git rm -rf --cached "$pattern" 2>/dev/null || true
              done < ".mirrorignore"
            fi

            echo "Removing mirror workflow files..."
            git rm -rf --cached .github/workflows/mirror.yml 2>/dev/null || true
            git rm -rf --cached .github/workflows/mirror_repo.yml 2>/dev/null || true

            git commit -m "Mirror sync: Applied .mirrorignore filters" || true
            git push mirror $branch:$branch --force
          done

      - name: Final cleanup
        run: |
          git reset --hard
          git clean -fd
